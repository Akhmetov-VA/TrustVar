# TrustLLM_ru

## Описание проекта

**TrustLLM_ru** — это система для оценки и мониторинга моделей машинного обучения в области обработки естественного языка. Проект включает в себя инструменты для загрузки и обработки данных, запуск инференса моделей, сбор метрик и визуализацию состояния экспериментов через веб-интерфейс.

## Содержание

- [Архитектура проекта](#архитектура-проекта)
- [Структура проекта](#структура-проекта)
- [Установка](#установка)
- [Настройка](#настройка)
- [Запуск проекта](#запуск-проекта)
  - [Запуск бекенда](#запуск-бекенда)
  - [Запуск обработчика задач](#запуск-обработчика-задач)
  - [Запуск обработчика метрик](#запуск-обработчика-метрик)
  - [Запуск мониторинга](#запуск-мониторинга)
- [Использование](#использование)
- [Вклад в проект](#вклад-в-проект)
- [Лицензия](#лицензия)

## Архитектура проекта

Архитектура инференса включает в себя следующие компоненты:

1. **MongoDB** — база данных для хранения задач и результатов.
2. **LangchainBackend** — серверная часть для обработки запросов и взаимодействия с моделями. (может ходить в Ollama/Yandex/OpenAI)
3. **StreamlitMonitoring** - граффический интерфейс для отображения метрик, текущего статуса обсчета с помощью LLM и запуск обсчета моделей из графического интерфейса 
4. **TaskRunner** - программа которая постоянно обходит всю ```MongoDB``` в поиске задач в статусе ```pending``` и отправляет их в ```LangchainBackend``` посе чего ответы LLM складывает в ```MongoDB``` 
5. **MetricRunner** - программа которая постоянно обходит некоторые таблицы в ```MongoDB``` в поиске задач в статусе ```completed``` по ним прогоняет регулярки сравнивает найденый результат и загружает метркии в ```MongoDB```

## Структура проекта

```plaintext
.
├── benchmark
│   ├── constants.py              # Константы и настройки проекта
│   ├── db_client.py              # Клиент для взаимодействия с MongoDB
│   ├── notebooks
│   │   ├── metrics.ipynb
│   │   ├── run.ipynb
│   │   └── trustllm.ipynb
│   ├── runers
│   │   ├── download_dataset.py    # Скрипт для загрузки датасетов
│   │   ├── drop_collection_pattern.py  # Скрипт для удаления коллекций по шаблону
│   │   ├── drop_pending.py        # Скрипт для удаления задач со статусом "pending"
│   │   ├── revert_measure.py      # Скрипт для отката измерений
│   │   ├── revert_old.py          # Скрипт для отката старых данных
│   │   ├── run_metric.py          # Скрипт для вычисления метрик
│   │   └── run.py                 # Основной скрипт для обработки задач
│   ├── src.py                     # Вспомогательные функции для задач
│   └── tasks
│       ├── awareness.py            # Модуль задач по осведомленности
│       ├── ethics.py               # Модуль задач по этике
│       ├── jailbreak.py            # Модуль задач по обходу ограничений
│       ├── ood.py                  # Модуль задач по обнаружению аномалий
│       ├── rubia.py                # Модуль задач Rubia
│       └── slava.py                # Модуль задач Slava
├── data
│   ├── dataset                     # Датасеты из Trust_LLM
│   │   ├── ethics
│   │   ├── fairness
│   │   ├── privacy
│   │   ├── robustness
│   │   ├── safety
│   │   └── truthfulness
│   ├── ethics
│   │   ├── per_ethics.csv
│   │   └── sit_ethics.csv
│   ├── ood
│   │   └── ood_detection_ru.json
│   ├── privacy
│   │   └── privacy_awareness_query.json
│   ├── rubia
│   │   └── rubia.tsv
│   ├── safety
│   │   └── jailbreak.json
│   └── slava
│       └── open_questions_data__one_answer.jsonl
├── langchain_back
│   ├── main.py                      # Основной скрипт бекенда Langchain
│   ├── README.md
│   └── test.py                      # Тестовый скрипт для Langchain
├── monitoring
│   └── app.py                       # Скрипт для веб-интерфейса мониторинга
├── output.log                       # Общий лог файл проекта
├── pyproject.toml                   # Конфигурационный файл Poetry
└── README.md                        # Основной файл документации
```

## Установка

### Требования

- **Python 3.11** или выше
- **MongoDB** установлен и запущен
- **Poetry** для управления зависимостями

### Шаги установки

1. **Клонируйте репозиторий:**

    ```bash
    git clone https://83.143.66.64:27367/lia_icii/trust_llm_ru.git
    cd TrustLLM_ru
    ```

2. **Установите Poetry (если ещё не установлен):**

    Следуйте [официальной инструкции](https://python-poetry.org/docs/#installation) для установки Poetry.

3. **Установите зависимости:**

    ```bash
    poetry install
    ```

4. **Создайте файл `.env` в корне проекта и добавьте необходимые переменные окружения:**

    ```dotenv
    MONGO_INITDB_ROOT_USERNAME=ваше_имя_пользователя
    MONGO_INITDB_ROOT_PASSWORD=ваш_пароль
    MONGO_HOST=localhost
    MONGO_INITDB_ROOT_PORT=27017
    API_URL=ваш_API_URL
    ```

    Замените значения на ваши собственные.

## Настройка

Убедитесь, что MongoDB запущен и доступен по указанным в `.env` параметрам. Также убедитесь, что API-ключи и другие переменные окружения настроены корректно.

## Запуск проекта

### Запуск бекенда

Бекенд отвечает за обработку запросов и взаимодействие с моделями.

1. **Создайте сессию `screen`:**

    ```bash
    screen -S langchain_back
    ```

2. **Активируйте виртуальное окружение:**

    ```bash
    source .venv/bin/activate
    ```

3. **Запустите бекенд:**

    ```bash
    python langchain_back/main.py
    ```

4. **Повторно подключиться к сессии:**

    ```bash
    screen -r langchain_back
    ```

### Запуск обработчика задач

Обработчик задач отвечает за выполнение задач, хранящихся в MongoDB.

```bash
screen -S my_session

/home/vadim/work/TrustLLM_ru/.venv/bin/python /home/vadim/work/TrustLLM_ru/benchmark/runers/run.py

screen -r my_session
```

### Запуск обработчика добавления задач в очередь RtA

Обработчик добавляет задачи из всех коллекций в MongoDB в очередь RtA для дальнейшей обработки.


    ```bash
    screen -S run_rta

    /home/vadim/work/TrustLLM_ru/.venv/bin/python /home/vadim/work/TrustLLM_ru/benchmark/runers/run_rta.py

    screen -r run_rta
    ```

### Запуск обработчика измерения метрик

Этот обработчик отвечает за обработку задач в коллекции RtA и вычисление метрик.

    ```bash
    screen -S run_metric
    
    /home/vadim/work/TrustLLM_ru/.venv/bin/python /home/vadim/work/TrustLLM_ru/benchmark/runners/run_metric.py

    screen -r run_metric
    ```


### Запуск task_runner

Смотрит какие задачи есть в таблице tasks и на их основе проверяет существование актуальных записей и создает соответствующие очереди

    ```bash
    screen -S task_runner

    /home/vadim/work/TrustLLM_ru/.venv/bin/python /home/vadim/work/TrustLLM_ru/benchmark/runers/task_processor.py

    screen -r task_runner
    ```

### Запуск извлекателя из ответов LLM

Смотрит какие задачи есть в таблице tasks и на их основе проверяет существование актуальных записей и создает соответствующие очереди

    ```bash
    screen -S run_regexp

    /home/vadim/work/TrustLLM_ru/.venv/bin/python /home/vadim/work/TrustLLM_ru/benchmark/runers/run_regexp.py

    screen -r run_regexp
    ```


### Запуск мониторинга вторая версия

Новая версия мониторинга, которая позволяет выбирать метрику и на ее основе выводить соответствующие таблицы

    ```bash
    screen -S monitoring2

    /home/vadim/work/TrustLLM_ru/.venv/bin/python -m streamlit run /home/vadim/work/TrustLLM_ru/monitoring/app_streamlit.py --server.port 27366

    screen -r monitoring2
    ```

## Использование

### Запуск всех компонентов

Для полноценной работы системы необходимо запустить все основные компоненты:

1. **Бекенд**: Обработка запросов и взаимодействие с моделями.
2. **Обработчик задач**: Извлечение и выполнение задач из MongoDB.
3. **Обработчик метрик**: Сбор и вычисление метрик на основе выполненных задач.
4. **Мониторинг**: Веб-интерфейс для отслеживания состояния экспериментов.

### Пошаговый запуск

1. **Запустите MongoDB** на вашем сервере или локальной машине.
2. **Настройте переменные окружения** в файле `.env`.
3. **Активируйте виртуальное окружение** и установите зависимости с помощью Poetry.
4. **Запустите все компоненты** согласно инструкциям в разделе [Запуск проекта](#запуск-проекта).

### Добавление задач

Чтобы добавить задачи для обработки:

1. **Используйте скрипты из `benchmark/src.py`, например, `load_task_mongo`.**
2. **Укажите модели и промпты**, которые необходимо обработать.
3. **Задачи автоматически будут обрабатываться обработчиком задач** и результаты будут сохраняться в MongoDB.

## Вклад в проект

Мы приветствуем вклад в развитие проекта! Если вы хотите внести изменения или улучшения:

1. **Форкните репозиторий**.
2. **Создайте новую ветку** для ваших изменений:

    ```bash
    git checkout -b feature/ваша-функция
    ```

3. **Внесите изменения** и **зафиксируйте их**:

    ```bash
    git commit -m "Добавлена новая функция"
    ```

4. **Запушьте ветку** в свой форк:

    ```bash
    git push origin feature/ваша-функция
    ```

5. **Создайте Pull Request** в оригинальный репозиторий.

