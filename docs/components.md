# Компоненты системы TrustVar

## Обзор компонентов

Система TrustVar состоит из нескольких ключевых компонентов, каждый из которых выполняет специфические функции в процессе оценки языковых моделей.

## 1. MongoDB - База данных

### Назначение
Основная база данных для хранения всех данных системы: задач, результатов, метрик и конфигураций.

### Основные коллекции

#### `tasks`
Содержит определения задач для обработки:
```json
{
  "task_name": "string",
  "dataset_name": "string", 
  "prompt": "string",
  "variables_cols": ["col1", "col2"],
  "models": ["model1", "model2"],
  "metric": "accuracy|RtA|correlation|include_exclude",
  "target": "string",
  "regexp": "string"
}
```

#### `queue_*`
Очереди задач для обработки:
```json
{
  "task_name": "string",
  "line_index": 0,
  "dataset_name": "string",
  "prompt": "string", 
  "variables": {"key": "value"},
  "model": "string",
  "metric": "string",
  "status": "pending|processing|completed|failed",
  "response": "string",
  "error": "string"
}
```

#### `queue_rta_*`
Специальные очереди для RtA (Refuse to Answer) задач:
```json
{
  "task_name": "string",
  "init_prompt": "string",
  "init_model": "string",
  "prompt": "string",
  "model": "string",
  "variables": {
    "input": "string",
    "answer": "string"
  },
  "metric": "accuracy",
  "status": "pending|completed|failed"
}
```

#### `dataset_*`
Датасеты для обработки:
```json
{
  "col1": "value1",
  "col2": "value2",
  "target": "expected_value"
}
```

## 2. Langchain Backend

### Назначение
Серверная часть для обработки запросов к языковым моделям и управления инференсом.

### Основные функции
- **Обработка запросов**: Прием запросов от runners и их передача в соответствующие модели
- **Интеграция с провайдерами**: Поддержка OpenAI, Yandex, Ollama и других провайдеров
- **Управление промптами**: Форматирование и обработка промптов
- **Обработка ответов**: Получение и форматирование ответов от моделей

### API Endpoints
- `POST /generate` - Основной endpoint для генерации ответов
- `GET /health` - Проверка состояния сервиса
- `GET /models` - Список доступных моделей

### Конфигурация
```python
# Поддерживаемые провайдеры
PROVIDERS = {
    "openai": OpenAIProvider,
    "yandex": YandexProvider, 
    "ollama": OllamaProvider
}
```

## 3. Streamlit Frontend

### Назначение
Современный веб-интерфейс для мониторинга и управления системой.

### Основные модули

#### `app_main.py`
Главное приложение с аутентификацией и навигацией:
- Аутентификация пользователей
- Управление сессиями
- Навигация между вкладками

#### `dataset_management.py`
Управление датасетами:
- Загрузка новых датасетов
- Просмотр существующих датасетов
- Редактирование и удаление датасетов

#### `prompts_tasks.py`
Создание и управление задачами:
- Создание новых задач
- Настройка промптов и метрик
- Выбор моделей для обработки

#### `tasks.py`
Визуализация задач:
- Отображение статуса задач
- Фильтрация и поиск
- Детальная информация о задачах

#### `metrics.py`
Отображение метрик:
- Графики и диаграммы
- Сравнение моделей
- Экспорт результатов

## 4. Task Runners

### Назначение
Набор специализированных обработчиков для автоматизации различных процессов в системе.

### Основные runners

#### `run.py` - Основной обработчик задач
**Функции:**
- Мониторинг коллекций `queue_*` в MongoDB
- Обработка задач со статусом `"pending"`
- Отправка запросов в Langchain Backend
- Обновление статусов задач

**Алгоритм работы:**
1. Подключение к MongoDB
2. Поиск задач со статусом `"pending"`
3. Изменение статуса на `"processing"`
4. Отправка запроса в Backend
5. Обновление результата и статуса

#### `task_processor.py` - Процессор задач
**Функции:**
- Чтение задач из коллекции `tasks`
- Создание записей в очередях `queue_*`
- Автоматическое формирование задач для обработки

**Алгоритм работы:**
1. Чтение всех задач из `tasks`
2. Для каждой задачи:
   - Загрузка соответствующего датасета
   - Создание записей для каждой строки датасета и модели
   - Проверка на дубликаты
   - Вставка новых записей

#### `run_rta_queuer.py` - Обработчик RtA задач
**Функции:**
- Перенос завершенных задач с метрикой "RtA" в специальные очереди
- Преобразование данных для RtA анализа
- Создание записей в `queue_rta_*`

**Алгоритм работы:**
1. Поиск задач с `metric: "RtA"` и `status: "completed"`
2. Проверка наличия обязательных полей (`rta_model`, `rta_prompt`)
3. Форматирование исходного промпта с переменными
4. Создание новой записи в RtA очереди
5. Обновление статуса исходной задачи

#### `run_metrics.py` - Обработчик метрик
**Функции:**
- Обработка завершенных задач
- Вычисление метрик качества
- Сохранение результатов в MongoDB

**Поддерживаемые метрики:**
- **Accuracy**: Точность ответов
- **Correlation**: Корреляция с эталонными ответами
- **Include/Exclude**: Анализ включения/исключения элементов
- **RtA**: Анализ отказа от ответа

#### `run_regexp.py` - Извлечение данных
**Функции:**
- Извлечение структурированных данных из ответов LLM
- Применение регулярных выражений
- Сохранение извлеченных данных

## 5. Ollama - Локальные модели

### Назначение
Сервис для запуска языковых моделей локально с поддержкой GPU.

### Конфигурация
```yaml
ollama:
  image: ollama/ollama:latest
  environment:
    - OLLAMA_HOST=0.0.0.0:12345
    - OLLAMA_MODELS=/models
  volumes:
    - /path/to/models:/models:ro
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            device_ids: ['1']
            capabilities: [gpu]
```

### Поддерживаемые модели
- Llama 3.1/3.2/3.3
- Qwen 2.5/3.0
- Mistral
- Gemma
- Saiga
- Vikhr
- И другие модели в формате GGUF

## 6. Utils - Утилиты

### `constants.py`
Централизованное хранение констант и конфигураций:
- Параметры подключения к MongoDB
- Списки поддерживаемых моделей
- Конфигурации метрик
- Промпты для RtA анализа

### `db_client.py`
Клиент для работы с MongoDB:
- Подключение к базе данных
- CRUD операции
- Утилиты для работы с коллекциями

### `src.py`
Вспомогательные функции:
- Форматирование данных
- Валидация входных данных
- Утилиты для работы с датасетами

## Взаимодействие компонентов

### Типичный поток обработки задачи

1. **Создание задачи** (через веб-интерфейс)
   ```
   User → Streamlit Frontend → MongoDB (tasks)
   ```

2. **Формирование очереди** (task_processor.py)
   ```
   task_processor → MongoDB (queue_*)
   ```

3. **Обработка задачи** (run.py)
   ```
   run.py → Langchain Backend → LLM → MongoDB (queue_*)
   ```

4. **Сбор метрик** (run_metrics.py)
   ```
   run_metrics → MongoDB (metrics)
   ```

5. **Визуализация** (Streamlit Frontend)
   ```
   Streamlit Frontend → MongoDB → User
   ```

### Специальные потоки

#### RtA анализ
1. Обычная задача → `queue_*` → `run.py` → Backend → LLM
2. Результат → `run_rta_queuer.py` → `queue_rta_*`
3. RtA задача → `run.py` → Backend → LLM
4. RtA результат → `run_metrics.py` → метрики

#### Извлечение данных
1. Завершенная задача → `run_regexp.py`
2. Применение регулярных выражений
3. Сохранение извлеченных данных

## Мониторинг и логирование

### Логирование
Все компоненты используют структурированное логирование:
- Уровни: INFO, WARNING, ERROR
- Формат: время, уровень, компонент, сообщение
- Вывод: консоль и файлы

### Метрики производительности
- Время обработки задач
- Количество обработанных запросов
- Ошибки и их типы
- Использование ресурсов

### Здоровье системы
- Проверка доступности MongoDB
- Мониторинг состояния runners
- Контроль доступности Backend
- Проверка подключения к Ollama 